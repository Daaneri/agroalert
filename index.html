<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ¿ AgroAlert - Asistente Inteligente de Plantas</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #e8f5e9, #c8e6c9);
      margin: 0;
      text-align: center;
      color: #1b5e20;
      padding: 20px;
    }

    h1 {
      font-size: 2em;
      color: #2e7d32;
      margin-bottom: 5px;
    }

    video, canvas {
      width: 90%;
      max-width: 420px;
      border-radius: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      margin-top: 15px;
    }

    button {
      background-color: #43a047;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 1em;
      border-radius: 8px;
      cursor: pointer;
      margin: 8px;
    }

    button:hover {
      background-color: #388e3c;
    }

    #resultado, #historial {
      background-color: #ffffffaa;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      width: 90%;
      max-width: 450px;
      margin-inline: auto;
      font-size: 1em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    #clima {
      margin-top: 15px;
      font-size: 1em;
      color: #33691e;
    }

    #historial ul {
      text-align: left;
      padding-left: 20px;
    }

    footer {
      margin-top: 30px;
      color: #4e4e4e;
      font-size: 0.85em;
    }

    .limpiar {
      background-color: #e53935;
    }
    .limpiar:hover {
      background-color: #c62828;
    }

  </style>
</head>
<body>

  <h1>ğŸŒ¿ AgroAlert</h1>
  <p>Tu asistente inteligente para identificar plantas, conocer su entorno y guardar tu historial.</p>

  <div id="clima">â³ Obteniendo clima...</div>

  <video id="video" autoplay playsinline></video><br>

  <button id="capturar">ğŸ“¸ Escanear Planta</button>
  <button id="cambiarCam">ğŸ” Cambiar CÃ¡mara</button>
  <button id="flashBtn">ğŸ’¡ Flash</button>

  <div id="resultado">Cargando modelo de IA...</div>

  <div id="historial">
    <h3>ğŸ“‹ Historial de Escaneos</h3>
    <ul id="listaHistorial"></ul>
    <button class="limpiar" id="limpiarHistorial">ğŸ—‘ï¸ Limpiar Historial</button>
  </div>

  <footer>ğŸŒ± Proyecto AgroAlert Â© 2025 | Creado por Cofla 24cm ğŸš€</footer>

  <script>
    const video = document.getElementById('video');
    const resultado = document.getElementById('resultado');
    const climaDiv = document.getElementById('clima');
    const listaHistorial = document.getElementById('listaHistorial');
    let modelo, stream, track, flashOn = false;
    let currentFacing = "environment";

    // ğŸ”¹ Obtener clima
    async function obtenerClima() {
      if (!navigator.geolocation) {
        climaDiv.textContent = "âš ï¸ Tu navegador no soporta geolocalizaciÃ³n.";
        return;
      }
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude, longitude } = pos.coords;
        const apiKey = "98c604119b6a2cae19503435edb7118f";
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${apiKey}&units=metric&lang=es`;
        try {
          const res = await fetch(url);
          const data = await res.json();
          const ciudad = data.name;
          const temp = data.main.temp;
          const desc = data.weather[0].description;
          climaDiv.textContent = `ğŸ“ ${ciudad} | ğŸŒ¡ï¸ ${temp}Â°C | ${desc}`;
        } catch {
          climaDiv.textContent = "âŒ Error al obtener el clima.";
        }
      });
    }

    // ğŸ”¹ Iniciar cÃ¡mara
    async function iniciarCamara() {
      if (stream) stream.getTracks().forEach(t => t.stop());
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: currentFacing } }
        });
        video.srcObject = stream;
        track = stream.getVideoTracks()[0];
      } catch (err) {
        resultado.textContent = "âš ï¸ Error al acceder a la cÃ¡mara: " + err.message;
      }
    }

    // ğŸ”¹ Cambiar cÃ¡mara
    document.getElementById('cambiarCam').addEventListener('click', async () => {
      currentFacing = currentFacing === "environment" ? "user" : "environment";
      await iniciarCamara();
    });

    // ğŸ”¹ Flash
    document.getElementById('flashBtn').addEventListener('click', async () => {
      if (!track) return alert("Primero iniciÃ¡ la cÃ¡mara.");
      const capabilities = track.getCapabilities();
      if (!capabilities.torch) {
        alert("âš ï¸ Tu cÃ¡mara no soporta flash desde el navegador.");
        return;
      }
      flashOn = !flashOn;
      await track.applyConstraints({ advanced: [{ torch: flashOn }] });
      document.getElementById('flashBtn').textContent = flashOn ? "ğŸ’¡ Flash ON" : "ğŸ’¡ Flash OFF";
    });

    // ğŸ”¹ Cargar modelo IA
    async function cargarModelo() {
      resultado.textContent = "Cargando modelo de inteligencia artificial...";
      modelo = await mobilenet.load();
      resultado.textContent = "âœ… Modelo cargado. ApuntÃ¡ una planta y presionÃ¡ 'Escanear Planta'.";
    }

    // ğŸ”¹ Escanear planta
    async function escanearPlanta() {
      if (!modelo) return alert("El modelo aÃºn no estÃ¡ listo...");
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const pred = await modelo.classify(canvas);

      if (pred && pred.length > 0) {
        const mejor = pred[0];
        const clima = climaDiv.textContent;
        const ahora = new Date().toLocaleString();

        let consejo = "ğŸŒ Ideal para zonas con buena luz.";
        const climaLower = clima.toLowerCase();
        if (climaLower.includes("lluvia") || climaLower.includes("humedad")) consejo = "ğŸ’§ Prefiere climas hÃºmedos.";
        else if (climaLower.includes("calor")) consejo = "ğŸ”¥ Tolera bien el calor.";

        resultado.innerHTML = `
          <h3>ğŸŒ¿ Planta detectada:</h3>
          <p><strong>${mejor.className}</strong></p>
          <p>ğŸ” Confianza: ${(mejor.probability * 100).toFixed(2)}%</p>
          <p>${consejo}</p>
          <p><em>Condiciones actuales:</em> ${clima}</p>
        `;

        // Guardar en historial
        const nuevoRegistro = {
          nombre: mejor.className,
          confianza: (mejor.probability * 100).toFixed(2),
          clima,
          fecha: ahora
        };
        guardarEnHistorial(nuevoRegistro);
        mostrarHistorial();
      } else {
        resultado.textContent = "âŒ No se pudo identificar la planta. IntentÃ¡ de nuevo.";
      }
    }

    document.getElementById('capturar').addEventListener('click', escanearPlanta);

    // ğŸ”¹ Historial
    function guardarEnHistorial(item) {
      let historial = JSON.parse(localStorage.getItem("historialAgroAlert")) || [];
      historial.unshift(item);
      localStorage.setItem("historialAgroAlert", JSON.stringify(historial.slice(0, 10)));
    }

    function mostrarHistorial() {
      listaHistorial.innerHTML = "";
      const historial = JSON.parse(localStorage.getItem("historialAgroAlert")) || [];
      if (historial.length === 0) {
        listaHistorial.innerHTML = "<li>No hay escaneos recientes.</li>";
        return;
      }
      historial.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `ğŸŒ¿ <strong>${item.nombre}</strong> (${item.confianza}%)
          <br>ğŸ“… ${item.fecha}
          <br>${item.clima}`;
        listaHistorial.appendChild(li);
      });
    }

    document.getElementById('limpiarHistorial').addEventListener('click', () => {
      localStorage.removeItem("historialAgroAlert");
      mostrarHistorial();
    });

    // ğŸ”¹ Iniciar todo
    obtenerClima();
    iniciarCamara();
    cargarModelo();
    mostrarHistorial();
  </script>

</body>
</html>





